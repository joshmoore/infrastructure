#!/bin/bash

# test_pg: assumes that a docker instance is available locally
# and that the current PYTHONPATH contains docker-py.

## VARIABLES

# On travis, it's assumed that the docker host is unencrypted.
# This will need to be "encrypt" for testing on docker-machine.
USE_TLS=${USE_TLS:-"no"}

# Using first python on the path, assuming that requirements
# have been pip installed
PYTHON="ansible_python_interpreter=$(which python)"

# Using a non-default port for postgres, assuming that a local
# instance is already running
PORT=${PORT:-5433}



TESTHOST="$(mktemp test_pg.XXXXXX)"
trap "rm -rf $TESTHOST" EXIT

cat - <<EOF > $TESTHOST
[docker-pg]
localhost docker_pg_port=$PORT docker_use_tls=$USE_TLS ansible_connection=local $PYTHON
EOF

ansible-playbook -i $TESTHOST ansible/pg-deployment.yml
